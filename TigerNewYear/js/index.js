var u=navigator.userAgent;var isiOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);var sound=new Howl({src:['http://music.163.com/song/media/outer/url?id=1911281371.mp3'],html5:true});var gameBeginTime='';var showTime=document.getElementById("showTime");var wx=window.innerWidth;var wy=window.innerHeight;var stage=document.getElementById('stage');stage.style.height=wy+'px';var monsterHpTxt=0;var monster=document.getElementById('monster');var monsterHP=document.getElementById("monsterHP");var monsterText=document.getElementById("monsterText");var doubleHitObj=document.getElementById("doubleHit");var monsterX=100;var monsterY=lastMonsterY;var lastMonsterY=30;var monsterSpeed=1;var monsterDown=wy/2*Math.random();var mosterIsMove=true;var Launcher=document.getElementById('Launcher');Launcher.style.left=wx/2-Launcher.offsetWidth/2+'px';var rect=Launcher.getBoundingClientRect();var LauncherX=rect.left+(rect.right-rect.left)/2;var LauncherY=rect.bottom;var gameDuration='00分00秒';var x=0;var y=0;var l=0;var t=0;var nx=LauncherX;var ny;var progress=0;var isDown=false;var isPlay=false;var lastBulletTime=0;var frequency=1;var bulletSpeed=10;var bulletHurt=1;var createBulletInterval=null;var rotation=0;var doubleHit=0;var showProp=1;var blessingProp=document.getElementById("blessingProp");var blessingY=0;var blessingNum=0;var isStartGame=false;var saveFlag=false;var boomMoster=document.getElementById("boomMoster");var boomMosterY=0;var boomMosterNum=0;var isBoomMoster=1;function formatTime(time){let minute=Math.floor(time/60000);let second=Math.floor(time%60000/1000);return`${minute}分${second}秒`};function startGame(){isStartGame=true;gameBeginTime=new Date().getTime();document.getElementById("menu").style.display="none";animloop()};function rankFind(){window.location.href="./message.html"};function animloop(){blessingMove();boomMosterMove();monsterMove();if(monsterHpTxt>=365){isStartGame=false;boomMoster.style.display="none";blessingProp.style.display="none";window.cancelAnimationFrame(animloop);document.getElementById("blessingLayer").style.display="inline-block";document.getElementById("blessingText").innerHTML=formatTime(gameDuration)}else{window.requestAnimationFrame(animloop)}};function easeInOutExpo(x){return x===0?0:x===1?1:x<0.5?Math.pow(2,20*x-8)/2:(2-Math.pow(2,-20*x+10))/2};function boomMosterMove(){if(isBoomMoster==2){isBoomMoster=0;boomMoster.style.left=parseInt(Math.random()*((wx-10)-10+1)+10,10)+'px';boomMoster.style.display="block"}else if(isBoomMoster==0){if(boomMosterY>wy){isBoomMoster=1;boomMosterY=0;boomMosterNum=0;frequency=1;boomMoster.style.display="none"}frequency<=2?boomMosterY+=1:boomMosterY+=2;boomMoster.style.top=boomMosterY+"px"}};function blessingMove(){if(showProp==2){showProp=0;blessingProp.style.left=parseInt(Math.random()*((wx-10)-10+1)+10,10)+'px';blessingProp.style.display="block"}else if(showProp==0){if(blessingY>wy){blessingY=0;showProp=1;blessingNum=0;blessingProp.style.display="none"}frequency<=2?blessingY+=1:blessingY+=2;blessingProp.style.top=blessingY+"px"}};function monsterMove(){gameDuration=new Date().getTime()-gameBeginTime;if(Math.floor(gameDuration%60000/1000)%20==0&&isBoomMoster==1){isBoomMoster=2};if(bulletHurt>1){showTime.style.color="#97caff";showTime.innerText="游戏时间: "+formatTime(gameDuration)+" 射速："+frequency+" buff伤害："+bulletHurt}else{showTime.style.color="#FBFF00";showTime.innerText="游戏时间: "+formatTime(gameDuration)+" 射速："+frequency}if(mosterIsMove){monster.style.transform="rotateY(180deg)";monsterText.style.transform="rotateY(180deg)";monsterX+=monsterSpeed;progress=parseInt((monsterX+100)/wx*100);if(progress>0&&progress<=30){monsterSpeed=1;monsterY=130}if(progress>30&&progress<=70){monsterSpeed=easeInOutExpo(progress/100)*10;monsterY=130+easeInOutExpo((progress-30)/40)*100}if(monsterX+100>=wx){mosterIsMove=false}}else{monster.style.transform="";monsterText.style.transform="";monsterX+=-monsterSpeed;progress=parseInt((wx-monsterX)/(wx-100)*100);if(progress>0&&progress<=30){monsterY=230}if(progress>30&&progress<=70){monsterSpeed=easeInOutExpo(progress/100)*10;monsterY=230-easeInOutExpo((progress-30)/40)*100}if(monsterX<30){mosterIsMove=true}}monster.style.left=monsterX+'px';monster.style.top=monsterY+'px'};function down(e){if(isStartGame){if(e.touches){let touch=e.touches[0];x=touch.clientX;y=touch.clientY}else{x=e.clientX;y=e.clientY}e.preventDefault();l=Launcher.offsetLeft;t=Launcher.offsetTop;isDown=true;createBullet();Launcher.style.cursor='move'}};function move(e){e.preventDefault();if(isDown==false){return}if(e.touches){let touch=e.touches[0];nx=touch.clientX;ny=touch.clientY}else{nx=e.clientX;ny=e.clientY}dx=nx-LauncherX;dy=ny-LauncherY;rotation=(Math.atan2(dy,dx)*180/Math.PI)+90;if(rotation<=-75||rotation>180){rotation=-75}else if(rotation>=75&&rotation<180){rotation=75}Launcher.style['transform']=Launcher.style['-webkit-transform']='rotate('+rotation+'deg)'};function up(){audio.pause();isDown=false;Launcher.style.cursor='default'};Launcher.onmousedown=function(e){down(e)};window.onmousemove=function(e){move(e)};window.onmouseup=function(){up()};Launcher.addEventListener('touchstart',function(e){down(e)},{passive:false});window.addEventListener('touchmove',function(e){move(e)},{passive:false});window.addEventListener('touchend',function(){up()},{passive:false});function tooglePlay(){if(!isPlay){sound.play();document.getElementById("soundIcon").src="https://bu.dusays.com/2022/01/17/ad7499aaeb2c8.png";isPlay=true}else{sound.pause();document.getElementById("soundIcon").src="https://bu.dusays.com/2022/01/17/46d3ff9dc2db8.png";isPlay=false}};var audio=new Howl({src:["image/pu.m4a"],html5:true,preload:true,volume:1});var audio2=new Howl({src:["image/boom.wav"],html5:true,preload:true,volume:1});function playAudio(){if(isPlay){if(isiOS){if(!audio.playing()){audio.play()}}else{audio.play()}}};function playAudio2(){if(isPlay){if(isiOS){if(!audio2.playing()){audio2.play()}}else{audio2.play()}}};function createBullet(){if(isDown==true){window.requestAnimationFrame(createBullet)}else{window.cancelAnimationFrame(createBullet)}var now=new Date().getTime();if(now-lastBulletTime>(1000/frequency)){var bullet=document.createElement('div');bullet.className='bullet';if(bulletHurt>1){bullet.style.background='url("https://bu.dusays.com/2022/01/19/9f77f145ec81d.png") -4px -2px / 18px no-repeat'}else{bullet.style.background='linear-gradient(to bottom, #ffee00, #ffe395)'}bullet.style['transform']=bullet.style['-webkit-transform']='rotate('+rotation+'deg)';bullet.style.left=LauncherX+Launcher.offsetHeight*Math.cos((90-rotation)/180*Math.PI)+'px';bullet.style.top=rotation<0?wy-Launcher.offsetHeight-(Launcher.offsetHeight-56)*Math.sin(rotation/180*Math.PI)+'px':wy-Launcher.offsetHeight+(Launcher.offsetHeight-56)*Math.sin(rotation/180*Math.PI)+'px';bullet.speen=rotation*.2;stage.appendChild(bullet);playAudio();function bulletMove(){bullet.style.top=bullet.offsetTop-bulletSpeed+'px';if(rotation>=-75&&rotation<0){bullet.style.left=bullet.offsetLeft+bullet.speen+'px'}if(rotation==0){bullet.style.left=bullet.offsetLeft+'px'}if(rotation>0&&rotation<75){bullet.style.left=bullet.offsetLeft+bullet.speen+'px'}if(bullet.offsetTop<=monster.offsetTop+monster.offsetHeight/2&&bullet.offsetTop>=monster.offsetTop&&bullet.offsetLeft>=monsterX&&bullet.offsetLeft<=monsterX+monster.offsetWidth){playAudio2();var imgF=document.createElement('div');imgF.className='imgF';imgF.style.left=bullet.offsetLeft+'px';imgF.style.top=bullet.offsetTop+'px';stage.appendChild(imgF);monsterHP.style.color="#FFE395";doubleHit+=1;doubleHitObj.innerHTML="连击："+doubleHit;doubleHit>1?doubleHitObj.style.display="inline-block":doubleHitObj.style.display="none";if(frequency<=2){if(doubleHit%2==0){if(showProp>0){showProp=2}else{showProp=0}}}else if(frequency>2&&frequency<=5){if(doubleHit%5==0){if(showProp>0){showProp=2}else{showProp=0}}}else if(frequency>5){if(doubleHit%10==0){if(showProp>0){showProp=2}else{showProp=0}}}monsterHpTxt=monsterHpTxt>=365?365:monsterHpTxt+bulletHurt;monsterHP.innerText="2022福气:"+monsterHpTxt+"天";monsterSpeed=.5;setTimeout(function(){doubleHitObj.style.display="none";monsterHP.style.color="#FFFFFF";monsterSpeed=1;stage.removeChild(imgF)},650);stage.removeChild(bullet);window.cancelAnimationFrame(bulletMove)}else if(bullet.offsetTop<=0||bullet.offsetLeft<=0||bullet.offsetLeft>wx){doubleHit=0;stage.removeChild(bullet);window.cancelAnimationFrame(bulletMove)}else if(bullet.offsetTop<=blessingProp.offsetTop+blessingProp.offsetHeight/2&&bullet.offsetTop>=blessingProp.offsetTop&&bullet.offsetLeft>=blessingProp.offsetLeft&&bullet.offsetLeft<=blessingProp.offsetLeft+monster.offsetWidth/2){var imgF=document.createElement('div');doubleHit+=1;blessingNum+=1;if(blessingNum>=3){frequency<=8?frequency+=1:frequency=8;blessingY=0;blessingNum=0;showProp=1;blessingProp.style.display="none"}imgF.className='imgF';imgF.style.left=bullet.offsetLeft+'px';imgF.style.top=bullet.offsetTop+'px';stage.appendChild(imgF);stage.removeChild(bullet);setTimeout(function(){stage.removeChild(imgF)},650)}else if(bullet.offsetTop<=boomMoster.offsetTop+boomMoster.offsetHeight/2&&bullet.offsetTop>=boomMoster.offsetTop&&bullet.offsetLeft>=boomMoster.offsetLeft&&bullet.offsetLeft<=boomMoster.offsetLeft+monster.offsetWidth/2){var imgF=document.createElement('div');doubleHit+=1;boomMosterNum+=1;switch(boomMosterNum){case 2:boomMoster.style.backgroundPosition='-58px 6px';break;case 3:boomMoster.style.backgroundPosition='-124px 6px';break;case 4:boomMoster.style.backgroundPosition='6px -64px';break;case 5:boomMoster.style.backgroundPosition='-58px -64px';break;case 6:boomMoster.style.backgroundPosition='-124px -64px';break}if(boomMosterNum>=6){bulletHurt=5;setTimeout(function(){bulletHurt=1},6000);boomMosterY=0;boomMosterNum=0;isBoomMoster=1;boomMoster.style.display="none"}imgF.className='imgF';imgF.style.left=bullet.offsetLeft+'px';imgF.style.top=bullet.offsetTop+'px';stage.appendChild(imgF);stage.removeChild(bullet);setTimeout(function(){stage.removeChild(imgF)},650)}else{window.requestAnimationFrame(bulletMove)}}bulletMove();lastBulletTime=now}};var blessingData=[];const{Query,User}=AV;var APP_ID='1503RVl8u0Sqp7ssKnVDiIJi-gzGzoHsz';var APP_KEY='avy3KAfLc6xrGxRxdOMrDvAG';var SERVER_URL="https://1503rvl8.lc-cn-n1-shared.com";AV.init({appId:APP_ID,appKey:APP_KEY,serverURL:SERVER_URL});var query=new AV.Query('NewYearMessage');query.find().then(function(e){blessingData=e.map(item=>{let name=item.attributes.name;let words=item.attributes.words;return{'name':name,'words':words}});showBullet()});var ballistic=0;var barrageSpeed=2;var bulletInterval=[100,300];var barrageBlock=document.getElementById("bulletChat");function showBullet(){let ballisticArr=[0,1,2,3,4,5];let ballisticLaunch=()=>{let randomIndex=Math.floor(Math.random()*ballisticArr.length);let ballisticIndex=ballisticArr.splice(randomIndex,1)[0];barrage(ballisticIndex);if(ballisticArr.length>0){setTimeout(ballisticLaunch,Math.random()*1000)}};ballisticLaunch()};function barrage(index){let bullet=document.createElement('div');let bulletHeight=wy/20;bullet.className='bullet-chat';bullet.style.left=wx+'px';bullet.style.top=index*bulletHeight+50+'px';bullet.createNext=false;bullet.nextSpace=Math.random()*(bulletInterval[1]-bulletInterval[0])+bulletInterval[0];let dataLength=blessingData.length;let randomIndex=Math.floor(Math.random()*dataLength);let blessing=blessingData[randomIndex];bullet.innerText=blessing.name+"："+blessing.words;barrageBlock.appendChild(bullet);let bulletMove=()=>{bullet.style.left=bullet.offsetLeft-barrageSpeed+'px';if(!bullet.createNext){if(bullet.offsetLeft<(wx-bullet.offsetWidth-bullet.nextSpace)){barrage(index);bullet.createNext=true}}if(bullet.offsetLeft<(-bullet.offsetWidth)){barrageBlock.removeChild(bullet)}else{requestAnimationFrame(bulletMove)}};bulletMove()}function saveInfo(){if(!saveFlag){let name=document.getElementById("name").value;let words=document.getElementById("words").value;let qqId=document.getElementById("qqId").value;let NewYearMessage=AV.Object.extend('NewYearMessage');let newYearMessage=new NewYearMessage();newYearMessage.save({words:words,qqID:qqId,name:name,timeUse:gameDuration}).then(function(e){alert('添加成功！');saveFlag=true;query.find().then(function(e){blessingData=e.map(item=>{let name=item.attributes.name;let words=item.attributes.words;return{'name':name,'words':words}})})})}};